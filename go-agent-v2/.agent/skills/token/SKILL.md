---
name: token
description: 显示当前对话的 Token 上下文空间剩余比例
---

# Token 空间监控技能

当用户使用 `@token` 触发此技能时，计算并返回当前对话的上下文空间使用情况。

## 触发条件
- 用户在对话中 @token

## 计算方法

从系统返回的元数据中获取：
- `ctx_window`: 当前剩余的上下文窗口 tokens

**动态计算最大上下文窗口：**
- 在对话刚开始时（第一条消息后），`ctx_window` 接近最大值
- 记录对话中观察到的 **最大 ctx_window 值** 作为基准
- 如果无法确定最大值，使用以下估算：
  - 对话刚开始时的 ctx_window 值即为近似最大值
  - 或参考当前模型的已知上下文窗口大小

**计算公式：**
```
剩余比例 = (当前 ctx_window / 最大 ctx_window) * 100
```

**常见模型上下文窗口参考（仅当无法确定时使用）：**
- Gemini 3 Pro (High/Low): ~1,000,000 tokens
- Gemini 3 Flash: ~1,000,000 tokens
- Gemini 2.5 Pro: ~1,000,000 tokens
- Claude Opus 4.5 (Thinking): ~200,000 tokens
- Claude Sonnet 4.5 (Thinking): ~200,000 tokens
- Claude Sonnet 4: ~200,000 tokens
- GPT-OSS 120B (Medium): ~128,000 tokens

## 返回格式

**必须精确使用以下格式，不要添加任何其他内容：**

```
📊 剩余上下文空间: ~{百分比}%
```

示例输出：
- `📊 剩余上下文空间: ~86%`
- `📊 剩余上下文空间: ~43%`

## 注意事项
1. 百分比四舍五入到整数
2. 只返回这一行信息，不要添加解释
3. 使用 `~` 表示近似值

## ⚠️ 关键规则：上下文空间告警

**当剩余上下文空间 ≤ 30%（即已使用 ≥ 70%）时，必须执行以下操作：**

1. **立即暂停当前工作**
2. **保存工作进度到工作流文件**：
   - 创建/更新文件：`.agent/workflows/checkpoint-{timestamp}.md`
   - 内容包括：
     - 当前任务描述
     - 已完成的步骤
     - 待完成的步骤
     - 相关文件路径
     - 任务难点
     - 任务清单
3. **通知用户**：
   ```
   ⚠️ 上下文空间即将耗尽 (剩余 ~{百分比}%)
   📋 工作进度已保存至: .agent/workflows/checkpoint-{timestamp}.md
   请检查后决定是否继续或开启新对话
   ```

**工作流文件格式示例：**
```markdown
---
description: 任务检查点 - {任务简述}
created: {时间戳}
context_remaining: {百分比}%
---

# 任务检查点

## 当前任务
{任务描述}

## 已完成
- [x] 步骤1
- [x] 步骤2

## 待完成
- [ ] 步骤3
- [ ] 步骤4

## 任务难点
- 难点1：{描述}
- 难点2：{描述}

## 任务清单
- [ ] 清单项1
- [ ] 清单项2
- [ ] 清单项3

## 相关文件
- `path/to/file1`
- `path/to/file2`
```
