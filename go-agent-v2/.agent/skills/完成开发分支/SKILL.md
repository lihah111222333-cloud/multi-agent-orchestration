---
name: 完成开发分支
description: 实现完成、所有测试通过、需要决定如何集成工作时使用 - 通过呈现合并、PR 或清理的结构化选项来指导开发工作的完成
aliases: ["@完成分支", "@finish-branch"]
---

# 完成开发分支

## 概述

通过呈现清晰选项并处理选择的工作流来指导开发工作的完成。

**核心原则：** 验证测试 → 呈现选项 → 执行选择 → 清理。

**开始时宣布：** "我正在使用完成开发分支技能来完成此工作。"

## 流程 (The Process)

### 第一步：验证测试 (Step 1: Verify Tests)

**呈现选项前，验证测试通过 (Before presenting options, verify tests pass)：**

```bash
# 运行项目测试套件 (Run project's test suite)
npm test / cargo test / pytest / go test ./...
```

**如果测试失败：**
```
测试失败（<N> 个失败）。完成前必须修复：

[显示失败]

测试通过前无法继续合并/PR。
```

停止。不要进入第二步。(Stop. Don't proceed to Step 2.)

**如果测试通过 (If tests pass):** 继续第二步。

### 第二步：确定基础分支 (Step 2: Determine Base Branch)

```bash
git merge-base HEAD main 2>/dev/null || git merge-base HEAD master 2>/dev/null
```

或询问："这个分支从 main 分出 - 对吗？"

### 第三步：呈现选项

呈现恰好这 4 个选项：

```
实现完成。你想做什么？

1. 本地合并回 <基础分支>
2. 推送并创建 Pull Request
3. 保持分支现状（我稍后处理）
4. 丢弃此工作

选哪个？
```

**不要加解释** - 保持选项简洁。

### 第四步：执行选择

#### 选项 1：本地合并

```bash
# 切换到基础分支
git checkout <基础分支>

# 拉取最新
git pull

# 合并功能分支
git merge <功能分支>

# 在合并结果上验证测试
<测试命令>

# 如果测试通过
git branch -d <功能分支>
```

然后：清理 worktree（第五步）

#### 选项 2：推送并创建 PR

```bash
# 推送分支
git push -u origin <功能分支>

# 创建 PR
gh pr create --title "<标题>" --body "$(cat <<'EOF'
## 摘要
<2-3 个变更要点>

## 测试计划
- [ ] <验证步骤>
EOF
)"
```

然后：清理 worktree（第五步）

#### 选项 3：保持现状

报告："保持分支 <名称>。Worktree 保留在 <路径>。"

**不要清理 worktree。**

#### 选项 4：丢弃

**先确认：**
```
这将永久删除：
- 分支 <名称>
- 所有提交：<提交列表>
- Worktree 于 <路径>

输入 'discard' 确认。
```

等待确切确认。

如果确认：
```bash
git checkout <基础分支>
git branch -D <功能分支>
```

然后：清理 worktree（第五步）

### 第五步：清理 Worktree

**对于选项 1、2、4：**

检查是否在 worktree 中：
```bash
git worktree list | grep $(git branch --show-current)
```

如果是：
```bash
git worktree remove <worktree-路径>
```

**对于选项 3：** 保留 worktree。

## 快速参考

| 选项 | 合并 | 推送 | 保留 Worktree | 清理分支 |
|------|------|------|---------------|----------|
| 1. 本地合并 | ✓ | - | - | ✓ |
| 2. 创建 PR | - | ✓ | ✓ | - |
| 3. 保持现状 | - | - | ✓ | - |
| 4. 丢弃 | - | - | - | ✓ (强制) |

## 常见错误

### 跳过测试验证
- **问题：** 合并损坏代码，创建失败的 PR
- **修复：** 总是在呈现选项前验证测试

### 开放式问题
- **问题：** "接下来做什么？" → 模糊
- **修复：** 恰好呈现 4 个结构化选项

### 自动清理 worktree
- **问题：** 移除可能需要的 worktree（选项 2、3）
- **修复：** 只为选项 1 和 4 清理

### 丢弃无确认
- **问题：** 意外删除工作
- **修复：** 需要输入 "discard" 确认

## 危险信号

**永不：**
- 测试失败时继续
- 不验证合并结果上的测试就合并
- 不确认就删除工作
- 没有明确请求就强制推送

**始终：**
- 呈现选项前验证测试
- 恰好呈现 4 个选项
- 选项 4 需要输入确认
- 只为选项 1 和 4 清理 worktree

## 集成

**被调用于：**
- `@子代理开发`（第 7 步）- 所有任务完成后
- `@执行计划`（第 5 步）- 所有批次完成后

**配对使用：**
- `@工作树` - 清理由该技能创建的 worktree
