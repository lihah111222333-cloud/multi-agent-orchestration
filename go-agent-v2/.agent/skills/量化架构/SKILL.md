---
name: é‡åŒ–æ¶æ„
description: WJBoot é‡åŒ–å¼•æ“çš„å››å±‚æ¶æ„è®¾è®¡ã€é…ç½®é©±åŠ¨æ¨¡å¼ä¸æ ¸å¿ƒæ¥å£æ˜ å°„ã€‚
tags: [quant, architecture, engine, factory, config, æ¶æ„, é‡åŒ–, å¼•æ“]
---

# é‡åŒ–æ¶æ„è®¾è®¡ (WJBoot V2)

> ğŸ—ï¸ **æ ¸å¿ƒç†å¿µ**: WJBoot é‡‡ç”¨ **å››å±‚è§£è€¦æ¶æ„** ä¸ **é…ç½®é©±åŠ¨ (IoC)** æ¨¡å¼ï¼Œå®ç°ä» YAML é…ç½®åˆ°æ‰§è¡Œå¼•æ“çš„å…¨é“¾è·¯è‡ªåŠ¨åŒ–ã€‚

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå››å±‚æ¶æ„ (Four-Layer Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: é…ç½®å±‚ (Config Layer)                          â”‚
â”‚  ä½ç½®: backend/internal/common/config               â”‚
â”‚  èŒè´£: å£°æ˜å¼å‚æ•°å®šä¹‰ï¼ˆç»“æ„ä½“/é…ç½®æ¨¡æ¿ï¼‰              â”‚
â”‚  è¾“å‡º: TradingConfig, BacktestConfig ç­‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ é…ç½®æ³¨å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: å·¥å‚å±‚ (Factory Layer) â­ æ ¸å¿ƒ                â”‚
â”‚  ä½ç½®: backend/internal/engine/factory              â”‚
â”‚  èŒè´£: é…ç½®éªŒè¯ã€é»˜è®¤å€¼æ³¨å…¥ã€å®ä¾‹åŒ–ç­–ç•¥/å¼•æ“         â”‚
â”‚  æ¨¡å¼: Registry + Factory Pattern                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ æ‰§è¡Œå™¨å®ä¾‹ (Strategy/Engine)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: æ‰§è¡Œæ ¸å¿ƒå±‚ (Execution Core Layer)              â”‚
â”‚  ä½ç½®: backend/internal/engine/context              â”‚
â”‚  èŒè´£: ç»Ÿä¸€äº¤æ˜“æ¥å£ï¼Œè¿è¡Œæ—¶çŠ¶æ€ç®¡ç†                  â”‚
â”‚  æ¥å£: StrategyContext (MarketData/Trading)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Context æ³¨å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L4: å¼•æ“å±‚ (Engine Layer)                          â”‚
â”‚  ä½ç½®: backend/internal/engine/engine               â”‚
â”‚  èŒè´£: Kçº¿åˆ†æµã€å¤šå“ç§æ’®åˆã€æµç¨‹ç¼–æ’                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šé…ç½®é©±åŠ¨ä¸å·¥å‚æ¨¡å¼

é…ç½®é€šè¿‡ `internal/common/config` ç»Ÿä¸€ç®¡ç†ï¼Œç­–ç•¥å·¥å‚ä½äº `internal/engine/factory`ã€‚

### é…ç½®ç»“æ„ (`internal/common/config/config.go`)

| é…ç½®ç±»å‹ | ç”¨é€” |
|---|---|
| `TradingConfig` | ç­–ç•¥è¿è¡Œå‚æ•° (æ æ†ã€ä»“ä½ã€æ—¶é—´èŒƒå›´) |
| `BacktestConfig` | å›æµ‹å‚æ•° (åˆå§‹èµ„é‡‘ã€æ‰‹ç»­è´¹ã€æ»‘ç‚¹) |
| `RiskConfig` | é£æ§å‚æ•° (æœ€å¤§å›æ’¤ã€ä»“ä½æ¯”ä¾‹) |
| `StrategyPolicy` | ç­–ç•¥è¿è¡Œç­–ç•¥é…ç½® |

### ç­–ç•¥å·¥å‚ (`internal/engine/factory/registry.go`)

```go
// æ³¨å†Œç­–ç•¥
factory.RegisterStrategy("RSIStrategy", func(params map[string]interface{}) (core.Strategy, error) {
    return strategy.NewRSIStrategy(params), nil
})

// åˆ›å»ºç­–ç•¥å®ä¾‹
s, _ := factory.CreateStrategy("RSIStrategy", map[string]interface{}{
    "period": 14,
    "overbought": 70,
})
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒé¢†åŸŸæ¥å£ (Domain Interfaces)

ç­–ç•¥ä¸å¼•æ“äº¤äº’çš„å”¯ä¸€é€šé“æ˜¯æ¥å£ (`backend/internal/engine/core/`)ã€‚

### 1. è¡Œæƒ…è®¿é—® (`MarketDataReader`)
ç±»å‹å®‰å…¨çš„è¡Œæƒ…è·å–ï¼Œæ›¿ä»£ DataFrame æ“ä½œã€‚

```go
type MarketDataReader interface {
    Close(offset int) decimal.Decimal  // è·å– offset æ ¹ K çº¿å‰çš„æ”¶ç›˜ä»·
    Low(offset int) decimal.Decimal    // è·å–æœ€ä½ä»·
    CloseSeries(length int) []decimal.Decimal // è·å–åºåˆ—
}
```

### 2. äº¤æ˜“æ“ä½œ (`TradingOperator`)
ç»Ÿä¸€çš„ä¸‹å•æ¥å£ï¼Œè‡ªåŠ¨é€‚é…å›æµ‹/å®ç›˜ã€‚

```go
type TradingOperator interface {
    OpenLong(qty, price decimal.Decimal) (*Order, error)
    OpenShort(qty, price decimal.Decimal) (*Order, error)
    CloseAll() error
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå›æµ‹å¼•æ“ä¿çœŸåº¦ (Fidelity)

ä¸ºäº†æ¶ˆé™¤ä»¿çœŸåå·® (Simulation-Reality Gap)ï¼Œå¼•æ“å†…ç½®äº†ä¸¥æ ¼çº¦æŸï¼š

1.  **å»¶è¿Ÿæˆäº¤ (Delayed Execution)**: Tæ—¶åˆ»äº§ç”Ÿçš„ä¿¡å·ï¼Œå¼ºåˆ¶åœ¨ T+1 æ—¶åˆ»ä»¥ Open ä»·æˆäº¤ (é™¤éæ˜¯é™ä»·å•)ã€‚
2.  **å¤šå“ç§å¯¹é½ (Alignment)**: å¼•æ“åˆ©ç”¨ Go Channel å¯¹å¤šå“ç§ K çº¿è¿›è¡Œæ—¶é—´æˆ³å¯¹é½ï¼Œé˜²æ­¢"æœªæ¥å‡½æ•°"ã€‚
3.  **åŠ¨æ€æ»‘ç‚¹**: åŸºäºæ³¢åŠ¨ç‡åŠ¨æ€è®¡ç®—æ»‘ç‚¹ï¼Œè€Œéå›ºå®šå€¼ã€‚

---

## æ£€æŸ¥æ¸…å•

- [ ] é…ç½®æ˜¯å¦ä½¿ç”¨ `common/config.MustLoad()` åŠ è½½ï¼Ÿ
- [ ] ç­–ç•¥é€»è¾‘æ˜¯å¦åªä¾èµ– `StrategyContext` æ¥å£ï¼Ÿ
- [ ] ç­–ç•¥æ˜¯å¦é€šè¿‡ `factory.RegisterStrategy` æ³¨å†Œï¼Ÿ
